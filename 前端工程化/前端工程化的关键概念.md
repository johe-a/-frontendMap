<!--
 * @Description: 
 * @Author: johe.huang
 * @Date: 2020-08-04 17:11:52
--> 
# 现代前端工作流
## 软件开发工作流
开发者在编程时，不管是什么语言，都会经历三个经典的工作流阶段：
- 初始化：在任何软件开发过程中，初始化都是第一步，这一阶段的任务是搭建项目或者向已有项目中添加新文件。
- 开发：这一阶段时写代码的阶段。如果需要加载更多模块或者想要把一些代码重构成一个新文件，就得回到初始化阶段。
- 部署：创建可执行文件并且部署。

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghex31925jj30gc08rq4n.jpg)

## javascript的工作流任务
![](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghexbfgj4sj30h60hiq8k.jpg)

### 初始化阶段的任务
初始化阶段的任务不是javascript专属的，是各种编程语言都适用的。一开始我们必须创建目录结构和第一个文件，才能开始编程。

1. 建立一个熟悉且可靠的目录结构
基于项目经验、或者通过脚手架工具（例如vue-cli）、又或者根据官方指南(例如vuex和vue-router都有官方推荐的目录结构)

一个常见的vue项目结构：
```
├── index.html                      入口页面
    ├── build                           构建脚本目录
    │   ├── build-server.js                 运行本地构建服务器，可以访问构建后的页面
    │   ├── build.js                        生产环境构建脚本
    │   ├── dev-client.js                   开发服务器热重载脚本，主要用来实现开发阶段的页面自动刷新
    │   ├── dev-server.js                   运行本地开发服务器
    │   ├── utils.js                        构建相关工具方法
    │   ├── webpack.base.conf.js            webpack基础配置
    │   ├── webpack.dev.conf.js             webpack开发环境配置
    │   └── webpack.prod.conf.js            webpack生产环境配置
    ├── config                          项目配置
    │   ├── dev.env.js                      开发环境变量
    │   ├── index.js                        项目配置文件
    │   ├── prod.env.js                     生产环境变量
    │   └── test.env.js                     测试环境变量
    ├── mock                            mock数据目录
    │   └── hello.js
    ├── package.json                    npm包配置文件，里面定义了项目的npm脚本，依赖包等信息
    ├── src                             项目源码目录    
    │   ├── main.js                         入口js文件
    │   ├── app.vue                         根组件
    │   ├── components                      公共组件目录
    │   │   └── title.vue
    │   ├── assets                          资源目录，这里的资源会被webpack构建
    │   │   └── images
    │   │       └── logo.png
    │   ├── routes                          前端路由
    │   │   └── index.js
    │   ├── store                           应用级数据（state）
    │   │   └── index.js
    │   └── views                           页面目录
    │       ├── hello.vue
    │       └── notfound.vue
    ├── static                          纯静态资源，不会被webpack构建。
    └── test                            测试文件目录（unit&e2e）
        └── unit                            单元测试
            ├── index.js                        入口脚本
            ├── karma.conf.js                   karma配置文件
            └── specs                           单测case目录
                └── Hello.spec.js
```

2. 复用模板代码
模板代码(boilerplate code)是几乎不加修改就可以添加到项目中的代码。模板代码不仅能够节约写代码的时间，还能确保那些常用的代码都能正确的引入项目中，有了模板代码，就不用一切从头开始，从而能够快速开发新项目。

例如我们新建项目中，一般都需要入口文件、模板页面等等，这些代码中有很多每次新建项目时都需要的代码，这部分代码可以抽象成模板代码。

3. 安装第三方软件和库
像Lodash这样的库能够提供一些工具函数来提高我们的开发效率。这些库也被称为依赖，意思是一个应用能否运行成功就依赖这些库了。


### 开发阶段的任务
1. 使用代码编译工具
现在很多人写前端都不会直接用原生的JS、CSS、HTML来写。而是使用其他语言(Sass、TypeScript)或者浏览器还未支持的新一代语法(es6、postcss)，但是浏览器不能直接解释这些语言，所以需要通过编译成浏览器可理解、可运行的代码。开发阶段和部署阶段都会用到代码编译工具。

2. 代码质量管理
开发者缩写的代码应该是高质量的代码。我们可以按照代码规范或者使用代码风格检查工具来帮助我们写出高质量的代码。例如ESLint以及JSLint这些工具都能根据一系列可配置的规则来检查开发者是否写出了不合规范的代码。开发阶段和部署阶段都包含代码质量管理的任务。

3. 运行开发服务器
由于我们编写的代码浏览器不能直接解析，一般由我们打包构建后放置在web服务器上进行访问，但是在开发环境下，每次都这样做会浪费很多时间。所以我们在开发环境下需要运行开发服务器，开发时访问开发服务器，一旦我们写的代码有更新，自动帮我们编译部署到开发服务器上。

### 部署阶段的任务
1. 打包和压缩JS和CSS文件
单位时间内过多的HTTP请求将会导致HTTP队头阻塞，这是由于HTTP版本限制以及浏览器对TCP连接的限制。所以我们最好减少单位时间内的请求次数，把文件进行压缩和合并（合并体积太大也不行，需要权衡）。HTML、CSS、JS基本上就是纯文本，相对于其他变成语言，它们不需要被编译成二进制文件(因为浏览器可以解析，编译成二进制反而不能解析)，所以我们要做的就是优化代码体积，例如移除空格、缩短函数和变量名等

2. 移除没有用到的代码
在开发中，我们可以会在应用中添加一些多余的调试代码。结果最后这些代码是没有作用的，白白占用了生产环境的流量。用户不会感觉到这些代码的存在，所以最好删掉这些代码。

3. 优化图片
图片在一个网页中的体重占据了相当大的部分。由于图片歌诗达额远古，图片文件本身存储了很多元信息。这些信息无法被浏览器解释，反而白白占用了图片的体积。

4. 执行单元测试和验收测试
单元测试确保模块的功能可以正常运行，而验收测试检查软件的输出结果能否满足特定需求。

5. 上传应用


新的工作流，加上了一些更详细的说明：

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghfsx3i3fjj30fe0kyk2r.jpg)


## 工作流产生的三类代码
工作流最终会产生三类代码：
- 套用代码（模板代码）
- 依赖代码（第三方库和依赖）
- 预处理代码（自己写的代码）

这三类代码分别对应三种工具：脚手架工具、依赖管理工具、构建工具

- 脚手架工具
脚手架工具专门用来处理模板代码。它能初始化模板代码，并且快速启动应用。还能创建目录结构，往现有项目里加入新模块，也就是它能完成两个初始化阶段的任务。另外，脚手架工具还能为安装构建工具和依赖管理工具打下必要的基础。

- 依赖管理工具
依赖管理工具用来处理独立的库和包，使用者不会触及内部逻辑，而只是把它们添加到自己的项目里，依赖管理工具还会处理包之间的依赖。如果开发者想要安装一个模块，但是这个模块却不满足现有模块的需求，那么依赖管理工具就会自动更新旧的依赖，或者至少提示开发者有依赖需要更新。

- 构建工具
预处理代码是开发者自己写的需要处理或者转换的代码。这部分代码一般是开发者耗时最多的代码。因为正是这部分代码实现了应用的各种量身打造的功能。开发者往往会使用Sass这样的CSS处理语言，并且打包JS代码。另外还得注意代码风格并执行代码检查工具。当准备部署代码的时候，还要压缩图片到最小体积，删除所有不需要的调试代码，删除没有用的CSS，并且尽量减少文件数量。  
构建工具专门用来应对所有的文件处理任务，把源代码转化成可以部署的代码，检查代码、编译、打包，这些任务构建工具也能够处理。

三个工具之间的交互：
![](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghfz1fed4aj30di0bh774.jpg)

开发者要做的就是控制这三个工具，首先使用脚手架工具(Vue-cli、create-react-app、Yeoman)搭建项目，然后使用依赖管理工具(Npm、Yarn、Bower)来搜索、安装依赖，接着使用构建工具(Webpack、Vite、Gulp)来处理文件。

### 脚手架工具的作用
搭建脚手架可以通过IDE完成，像Eclipse、webStorm这类工具中，我们可以使用模板创建一个新项目。通常会有一个向导来询问一些搭建脚手架所必须的参数。但是如果使用IDE来搭建脚手架，我们在开发过程就得一直使用它，并且要求同事也得使用相同的IDE。这种时候，像Yeoman、Vue-cli和create-react-app这种独立的命令行脚手架工具就有巨大的优势，无论环境和工具链怎么改变，都可以使用命令行脚手架工具来搭建。

使用Vue-cli来搭建脚手架：

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghg10kmt5cj314q0cajud.jpg)

最终生成的目录结构：

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghg11ynwbgj30c60koabk.jpg)


### 依赖管理工具
依赖管理工具的主要功能是在仓库中搜索依赖（这个仓库可以是社区的也可以是公司的私有仓库），并且下载到本地的项目中。由于包也可以拥有依赖，因此依赖管理工具的任务绝不仅仅只是把文件下载下来而已。**如果有两个及以上的包都依赖jQuery，但是依赖的版本却不同，那么依赖管理工具就要解决这个冲突。解决方法可以是选择其中一个，也可以两个都安装，或者是让用户来决定选择哪一个。**

为了解决依赖冲突，存在两种依赖管理方式，一种是深依赖树（例如Npm），另一种是扁平依赖树（例如Bower）。依赖树是用来展示依赖之间的关系的。以Bootstrap为例子，它需要jQuery才能运行。在依赖树中，jQuery是Bootstarp的子节点。如果我们安装了另一个依赖jQuery的组件，则有两个选择：
- 再次下载jQuery，然后把jQuery作为这个新的组件的子节点
- 把这个新组件引用的jQuery指向已经安装的jQuery

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghg3hr6yf5j30gi0aigpf.jpg)
